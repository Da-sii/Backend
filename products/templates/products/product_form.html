<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <title>제품 추가</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        h1 { margin-bottom: 30px; }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            overflow: visible;
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 12px;
            margin-bottom: 6px;
        }

        input[type="text"], select {
            width: 100%;
            height: 38px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }

        button {
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #fff;
        }

        .btn-add {
            background: #2196f3;
            padding: 8px 16px;
            margin-top: 10px;
        }

        .btn-remove {
            background: #f44336;
            height: 38px;
            font-weight: 600;
        }

        /* 성분 row */
        .dynamic-item {
            display: grid;
            grid-template-columns: minmax(0,1fr) 180px 90px;
            gap: 12px;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Select2 보정 */
        .select2-container { width: 100% !important; }
        .select2-container--open { z-index: 9999; }
        .select2-selection--single {
            height: 38px;
            display: flex;
            align-items: center;
        }

        /* 제품 리스트 */
        .product-list { margin-top: 50px; }

        .product-item {
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 16px;
            background: #fff;
        }

        .product-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .product-title-area {
            min-width: 0;
        }

        .product-title {
            font-size: 18px;
            font-weight: 700;
        }

        .product-id {
            font-size: 13px;
            color: #999;
            margin-left: 6px;
        }

        .product-meta {
            font-size: 14px;
            color: #666;
            margin-top: 6px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .ingredient-chip {
            background: #f1f3f5;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 13px;
        }

        .ingredient-chip strong { margin-left: 4px; }

        .btn-edit {
            background: #2196f3;
            padding: 8px 14px;
            border-radius: 6px;
            color: #fff;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-delete {
            background: #f44336;
            padding: 8px 14px;
            border-radius: 6px;
            color: #fff;
            text-decoration: none;
            white-space: nowrap;
        }

        .product-ingredients {
            margin-top: 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .nav-links a { margin-right: 15px; text-decoration: none; color: #2196f3; }
        .nav-links a:hover { text-decoration: underline; }
    </style>
</head>

<body>
<div class="container">

    <div class="nav-links">
        <a href="{% url 'admin_big_category_form' %}">대분류 카테고리</a>
        <a href="{% url 'admin_small_category_form' %}">소분류 카테고리</a>
        <a href="{% url 'admin_ingredient_form' %}">성분</a>
    </div>

<h1>제품 추가</h1>

<form method="POST" enctype="multipart/form-data">
{% csrf_token %}

<!-- 기본 정보 -->
<div class="form-section">
    <h2>기본 정보</h2>

    <label>제품 이름</label>
    <input type="text" name="name" required>

    <label>회사</label>
    <input type="text" name="company" required>

    <label>식품 유형</label>
    <input type="text" name="productType" required>

    <label>쿠팡 링크</label>
    <input type="text" name="coupang" required>
</div>

<!-- 이미지 -->
<div class="form-section">
    <h2>제품 이미지</h2>
    <input type="file" name="image_files" multiple>
</div>

<!-- 성분 -->
<div class="form-section">
    <h2>성분</h2>

    <!-- 성분 템플릿 -->
    <select id="ingredientTemplate" style="display:none;">
        <option value="">-- 성분 검색 --</option>
        {% for ing in ingredients %}
            <option value="{{ ing.id }}">{{ ing.name }}</option>
        {% endfor %}
    </select>

    <div id="ingredientContainer">
        <div class="dynamic-item">
            <select name="ingredient_ids[]" class="ingredient-select">
                <option value="">-- 성분 검색 --</option>
                {% for ing in ingredients %}
                    <option value="{{ ing.id }}">{{ ing.name }}</option>
                {% endfor %}
            </select>
            <input type="text" name="amounts[]" placeholder="예: 1000mg">
            <button type="button" class="btn-remove" onclick="removeIngredient(this)">삭제</button>
        </div>
    </div>

    <button type="button" class="btn-add" onclick="addIngredient()">+ 성분 추가</button>
</div>

<!-- 카테고리 -->
<div class="form-section">
    <h2>카테고리</h2>

    <div id="categoryContainer">
        <div class="dynamic-item">
            <select name="category_ids[]">
                <option value="">-- 카테고리 선택 --</option>
                {% for category in small_categories %}
                <option value="{{ category.id }}">
                    [{{ category.bigCategory.category }}] {{ category.category }}
                </option>
                {% endfor %}
            </select>
            <button type="button"
                    class="btn-remove"
                    onclick="this.parentElement.remove()">
                삭제
            </button>
        </div>
    </div>

    <button type="button" class="btn-add" onclick="addCategoryField()">
        카테고리 추가
    </button>
</div>


<button type="submit" style="background:#4caf50;padding:10px 20px;">
    제품 추가하기
</button>
</form>

<!-- ================= 제품 리스트 ================= -->
<div class="product-list">
<h2>등록된 제품 목록</h2>

{% for product in products %}
<div class="product-item">
    <div class="product-top">
        <div class="product-title-area">
            <div class="product-title">
                {{ product.name }}
                <span class="product-id">#{{ product.id }}</span>
            </div>

            <div class="product-meta">
                {{ product.company }} · {{ product.productType }}
            </div>
        </div>

        <div class="product-actions">
            <a href="{% url 'admin_product_edit' product.id %}" class="btn-edit">수정</a>
            <a href="{% url 'admin_product_edit' product.id %}?action=delete" class="btn-delete">삭제</a>
        </div>
    </div>

    {% if product.ingredients.all %}
    <div class="product-ingredients">
        {% for pi in product.ingredients.all %}
        <span class="ingredient-chip">
            {{ pi.ingredient.name }} <strong>{{ pi.amount }}</strong>
        </span>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endfor %}
</div>

</div>

<script>
function normalize(text) {
    return text.toLowerCase().replace(/\s+/g,'');
}

function matcher(params, data) {
    if (!params.term) return data;
    if (!data.text) return null;
    return normalize(data.text).includes(normalize(params.term)) ? data : null;
}

function initSelect2(el) {
    $(el).select2({
        width: '100%',
        placeholder: '성분 검색',
        matcher: matcher
    });
}

function removeIngredient(btn) {
    const container = document.getElementById('ingredientContainer');
    if (container.children.length <= 1) {
        alert('성분은 최소 1개 이상 필요합니다.');
        return;
    }
    btn.parentElement.remove();
}

function addIngredient() {
    const container = document.getElementById('ingredientContainer');
    const template = document.getElementById('ingredientTemplate');

    const div = document.createElement('div');
    div.className = 'dynamic-item';

    const select = document.createElement('select');
    select.name = 'ingredient_ids[]';
    select.className = 'ingredient-select';
    select.innerHTML = template.innerHTML;

    const input = document.createElement('input');
    input.type = 'text';
    input.name = 'amounts[]';
    input.placeholder = '예: 1000mg';

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn-remove';
    btn.textContent = '삭제';
    btn.onclick = () => removeIngredient(btn);

    div.appendChild(select);
    div.appendChild(input);
    div.appendChild(btn);

    container.appendChild(div);
    initSelect2(select);
}

function addCategoryField() {
    const container = document.getElementById('categoryContainer');
    const firstSelect = container.querySelector('select');

    const div = document.createElement('div');
    div.className = 'dynamic-item';

    div.innerHTML = `
        <select name="category_ids[]">
            ${firstSelect.innerHTML}
        </select>
        <button type="button" class="btn-remove"
                onclick="this.parentElement.remove()">삭제</button>
    `;

    container.appendChild(div);
}

$(document).ready(function () {
    document.querySelectorAll('.ingredient-select').forEach(initSelect2);
});
</script>

</body>
</html>
